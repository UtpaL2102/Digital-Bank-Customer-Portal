generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma-client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") // ...?schema=accounts
}

model Branch {
  id         String   @id @default(uuid()) @db.Uuid
  name       String
  code       String   @unique
  address    String?
  created_at DateTime @default(now())

  employees Employee[]
  accounts  Account[]
  loans     Loan[]
}

model Employee {
  id        String  @id @default(uuid()) @db.Uuid
  user_id   String  @db.Uuid // foreign to auth.
  branch_id String  @db.Uuid
  position  String?

  branch           Branch         @relation(fields: [branch_id], references: [id])
  reviewedRequests LimitRequest[] @relation("EmployeeReviews") // <-- added reverse
}

model Account {
  id             String    @id @default(uuid()) @db.Uuid
  account_number String    @unique
  account_type   String
  status         String    @default("active")
  balance        Decimal   @db.Decimal(19, 2)
  daily_limit    Decimal?  @db.Decimal(19, 2)
  monthly_limit  Decimal?  @db.Decimal(19, 2)
  user_id        String    @db.Uuid // foreign to auth.users (no Prisma relation)
  branch_id      String?   @db.Uuid
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt
  closed_at      DateTime?

  branch        Branch?             @relation(fields: [branch_id], references: [id])
  fromTxns      Transaction[]       @relation("fromTransactions")
  toTxns        Transaction[]       @relation("toTransactions")
  statements    Statement[]
  loans         Loan[]
  scheduledFrom ScheduledTransfer[] @relation("scheduledFrom")
  scheduledTo   ScheduledTransfer[] @relation("scheduledTo")
  limitRequests LimitRequest[] // <-- added reverse
}

model Beneficiary {
  id             String   @id @default(uuid()) @db.Uuid
  user_id        String   @db.Uuid // foreign to auth.users
  name           String
  bank_name      String?
  account_number String
  ifsc_swift     String?
  currency       String   @default("INR")
  is_active      Boolean  @default(true)
  created_at     DateTime @default(now())
  updated_at     DateTime @default(now())

  transactions       Transaction[]
  scheduledTransfers ScheduledTransfer[] @relation("BeneficiaryTransfers")
}

model Transaction {
  id                String   @id @default(uuid()) @db.Uuid
  created_at        DateTime @default(now())
  amount            Decimal  @db.Decimal(19, 2)
  status            String   @default("pending")
  type              String   @default("transfer")
  description       String?
  idempotency_key   String?
  from_account_id   String   @db.Uuid
  to_account_id     String?  @db.Uuid
  to_beneficiary_id String?  @db.Uuid
  initiated_by      String   @db.Uuid // foreign to auth.users
  
  // Scheduled transfer fields
  next_run_at       DateTime?
  last_run_at       DateTime?
  
  // Monitoring fields
  started_at        DateTime @default(now())
  completed_at      DateTime?
  processing_time   Int?     // in milliseconds
  error_code        String?
  error_message     String?
  retry_count       Int      @default(0)
  last_retry_at     DateTime?
  monitoring_status String   @default("normal") // normal, warning, error

  fromAccount   Account      @relation("fromTransactions", fields: [from_account_id], references: [id])
  toAccount     Account?     @relation("toTransactions", fields: [to_account_id], references: [id])
  toBeneficiary Beneficiary? @relation(fields: [to_beneficiary_id], references: [id])
  disputes      Dispute[] // <-- added reverse

  @@index([from_account_id, created_at])
  @@index([to_account_id, created_at])
  @@index([to_beneficiary_id, created_at])
}

model Statement {
  id         String   @id @default(uuid()) @db.Uuid
  user_id    String   @db.Uuid // foreign to auth.users
  account_id String   @db.Uuid
  date_from  DateTime
  date_to    DateTime
  format     String   @default("PDF")
  delivery   String   @default("download")
  file_url   String?
  status     String   @default("completed")
  created_at DateTime @default(now())

  account Account @relation(fields: [account_id], references: [id])
}

model ScheduledTransfer {
  id                String    @id @default(uuid()) @db.Uuid
  user_id           String    @db.Uuid
  from_account_id   String    @db.Uuid
  to_account_id     String?   @db.Uuid
  to_beneficiary_id String?   @db.Uuid
  amount            Decimal   @db.Decimal(19, 2)
  description       String?
  frequency         String    @default("monthly")
  next_run_at       DateTime
  end_date          DateTime?
  occurrences_left  Int?
  status            String    @default("active")
  created_at        DateTime  @default(now())
  updated_at        DateTime  @default(now())

  fromAccount   Account      @relation("scheduledFrom", fields: [from_account_id], references: [id])
  toAccount     Account?     @relation("scheduledTo", fields: [to_account_id], references: [id])
  toBeneficiary Beneficiary? @relation("BeneficiaryTransfers", fields: [to_beneficiary_id], references: [id])
}

model Dispute {
  id              String    @id @default(uuid()) @db.Uuid
  user_id         String    @db.Uuid
  transaction_id  String    @db.Uuid
  reason          String
  description     String?
  status          String    @default("submitted")
  created_at      DateTime  @default(now())
  resolved_at     DateTime?
  resolution_note String?

  transaction Transaction         @relation(fields: [transaction_id], references: [id])
  attachments DisputeAttachment[]
}

model DisputeAttachment {
  id         String   @id @default(uuid()) @db.Uuid
  dispute_id String   @db.Uuid
  file_url   String
  file_hash  String?
  created_at DateTime @default(now())

  dispute Dispute @relation(fields: [dispute_id], references: [id])
}

model LimitRequest {
  id                      String    @id @default(uuid()) @db.Uuid
  user_id                 String    @db.Uuid
  account_id              String    @db.Uuid
  current_daily_limit     Decimal?  @db.Decimal(19, 2)
  current_monthly_limit   Decimal?  @db.Decimal(19, 2)
  requested_daily_limit   Decimal?  @db.Decimal(19, 2)
  requested_monthly_limit Decimal?  @db.Decimal(19, 2)
  reason                  String?
  status                  String    @default("pending")
  created_at              DateTime  @default(now())
  decided_at              DateTime?
  reviewer_employee_id    String?   @db.Uuid
  decision_note           String?

  account  Account             @relation(fields: [account_id], references: [id])
  reviewer Employee?           @relation("EmployeeReviews", fields: [reviewer_employee_id], references: [id])
  events   LimitRequestEvent[]
}

model LimitRequestEvent {
  id                String   @id @default(uuid()) @db.Uuid
  limit_request_id  String   @db.Uuid
  action            String
  actor_user_id     String?  @db.Uuid
  actor_employee_id String?  @db.Uuid
  note              String?
  created_at        DateTime @default(now())

  request LimitRequest @relation(fields: [limit_request_id], references: [id])
}

model Loan {
  id            String    @id @default(uuid()) @db.Uuid
  user_id       String    @db.Uuid
  account_id    String    @db.Uuid
  branch_id     String    @db.Uuid
  amount        Decimal   @db.Decimal(19, 2)
  interest_rate Decimal   @db.Decimal(5, 2)
  start_date    DateTime
  end_date      DateTime?
  status        String
  created_at    DateTime  @default(now())

  account Account @relation(fields: [account_id], references: [id])
  branch  Branch  @relation(fields: [branch_id], references: [id])
}

model Notification {
  id      String    @id @default(uuid()) @db.Uuid
  user_id String    @db.Uuid
  type    String
  message String
  status  String    @default("unread")
  sent_at DateTime?
}

model AuditLog {
  id              String   @id @default(uuid()) @db.Uuid
  user_id         String   @db.Uuid
  action          String
  action_type     String   // create, update, delete, view, etc.
  resource_type   String   // account, transaction, beneficiary, etc.
  resource_id     String?  @db.Uuid
  details         String?
  performed_at    DateTime @default(now())
  ip_address      String?
  user_agent      String?
  status          String   @default("success") // success, failure
  error_details   String?
  related_user_id String?  @db.Uuid // if action affects another user
  severity_level  String   @default("info") // info, warning, error, critical

  @@index([user_id, performed_at])
  @@index([action_type, performed_at])
  @@index([resource_type, resource_id])
  @@index([severity_level, performed_at])
}

model TransferMonitoring {
  id                        String   @id @default(uuid()) @db.Uuid
  timestamp                 DateTime @default(now())
  interval_start           DateTime // start of monitoring interval
  interval_end             DateTime // end of monitoring interval
  total_transfers          Int
  successful_transfers     Int
  failed_transfers         Int
  total_amount            Decimal  @db.Decimal(19, 2)
  avg_processing_time     Int      // in milliseconds
  max_processing_time     Int      // in milliseconds
  error_count             Int
  warning_count           Int
  most_common_error       String?
  most_common_error_count Int?
  system_health_status    String   @default("healthy") // healthy, degraded, critical

  @@index([timestamp])
  @@index([interval_start, interval_end])
}

model SystemConfig {
  id                String   @id @default(uuid()) @db.Uuid
  key               String   @unique
  value             String
  description       String?
  category          String   // limits, monitoring, security, etc.
  last_updated_at   DateTime @updatedAt
  last_updated_by   String   @db.Uuid // foreign to auth.users
  is_active         Boolean  @default(true)

  // Monitoring thresholds
  max_retry_attempts        Int     @default(3)
  processing_time_threshold Int     @default(30000) // in milliseconds
  error_rate_threshold     Decimal @default(0.05) @db.Decimal(5, 4) // 5%
  warning_threshold        Decimal @default(0.10) @db.Decimal(5, 4) // 10%

  // Default limits
  default_daily_limit     Decimal @default(100000) @db.Decimal(19, 2)
  default_monthly_limit   Decimal @default(1000000) @db.Decimal(19, 2)
  max_daily_limit        Decimal @default(500000) @db.Decimal(19, 2)
  max_monthly_limit      Decimal @default(5000000) @db.Decimal(19, 2)

  @@index([category])
}
